<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ROMetrics | Create Account</title>

<link rel="icon" type="image/png" sizes="192x192" href="favicon-192.png">
<link rel="apple-touch-icon" sizes="192x192" href="favicon-192.png">

<style>
:root {
  --bg: #0b1120; 
  --card: #1e293b;
  --primary: #38bdf8; 
  --text: #f8fafc;
  --text-muted: #94a3b8;
  --border: #334155;
  --error: #fb7185;
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.auth-card {
  width: 100%;
  max-width: 450px;
  background: var(--card);
  border: 1px solid var(--border);
  border-top: 4px solid var(--primary);
  border-radius: 24px;
  padding: 40px 32px;
}
.logo-header { text-align: center; margin-bottom: 24px; }
.logo { height: 42px; margin-bottom: 12px; }
h1 { font-size: 1.4rem; font-weight: 800; margin: 0 0 8px; }
p { font-size: 0.85rem; color: var(--text-muted); margin: 0 0 24px; }
.console-msg {
  background: #0f172a;
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 12px;
  font-size: 12px;
  font-weight: 600;
  text-align: center;
  margin-bottom: 20px;
  display: none;
}
.console-error { border-color: var(--error); color: var(--error); }
.console-info { border-color: var(--primary); color: var(--primary); }
.input-group { margin-bottom: 16px; }
.input-label {
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  color: var(--primary);
  margin-bottom: 6px;
  display: block;
}
input {
  width: 100%;
  background: #0f172a;
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 12px 16px;
  color: #fff;
}
.btn {
  width: 100%;
  padding: 14px;
  border-radius: 12px;
  font-weight: 700;
  cursor: pointer;
  border: none;
}
.btn-primary { background: var(--primary); color: #0b1120; }
.switch-link {
  text-align: center;
  margin-top: 24px;
  font-size: 0.85rem;
  color: var(--text-muted);
}
.switch-link a { color: var(--primary); text-decoration: none; font-weight: 700; }
</style>
</head>

<body>

<div class="auth-card" id="regFormContainer">
  <div class="logo-header">
    <a href="https://rometrics.app/">
      <img src="rometrics-logo.png" class="logo" alt="ROMetrics">
    </a>
    <h1>Create Account</h1>
    <p>Your first month of Premium is free.</p>
  </div>

  <div id="regConsole" class="console-msg"></div>

  <div class="input-group">
    <span class="input-label">Full Name</span>
    <input id="regName" type="text">
  </div>

  <div class="input-group">
    <span class="input-label">Username</span>
    <input id="regUsername" type="text" maxlength="9">
  </div>

  <div class="input-group">
    <span class="input-label">Email</span>
    <input id="regEmail" type="email">
  </div>

  <div class="input-group">
    <span class="input-label">Password</span>
    <input id="regPass" type="password">
  </div>

  <div class="input-group">
    <span class="input-label">Confirm Password</span>
    <input id="regConfirm" type="password">
  </div>

  <button class="btn btn-primary" id="doRegister" type="button">Create Account</button>

  <div class="switch-link">
    Already have an account? <a href="signin.html">Sign In</a>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

  if (!firebase.apps.length) {
    firebase.initializeApp({
      apiKey: "AIzaSyAxMFW5gguPiiaomPbuoMc7suxHmgPEhRg",
      authDomain: "rometricsapp-1444e.firebaseapp.com",
      projectId: "rometricsapp-1444e",
      appId: "1:1016564998048:web:1d4c7e4780de0323664ec5"
    });
  }

  const auth = firebase.auth();
  const db   = firebase.firestore();

  const msg = (text, type = "error") => {
    const el = document.getElementById("regConsole");
    if (!el) return;
    el.textContent = text;
    el.className = `console-msg console-${type}`;
    el.style.display = "block";
  };

  document.getElementById("doRegister").onclick = async () => {
    const fullName = regName.value.trim();
    const username = regUsername.value.trim().toLowerCase();
    const email    = regEmail.value.trim().toLowerCase();
    const pass     = regPass.value;
    const confirm  = regConfirm.value;

    if (!fullName || !username || !email || !pass)
      return msg("All fields are required.");
    if (username.length > 9)
      return msg("Username max 9 characters.");
    if (pass !== confirm)
      return msg("Passwords do not match.");

    try {
      // Check username uniqueness
      const existing = await db.collection("users")
        .where("username", "==", username)
        .limit(1)
        .get();

      if (!existing.empty)
        return msg("Username is already taken.");

      // Create Auth user
      const cred = await auth.createUserWithEmailAndPassword(email, pass);

      // Create Firestore profile IMMEDIATELY
      await db.collection("users").doc(cred.user.uid).set({
        email,
        username,
        fullName,
        provider: "password",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      // Send verification email
      await cred.user.sendEmailVerification();

      // Stay signed in but block access elsewhere
      document.getElementById("regFormContainer").innerHTML = `
        <div style="text-align:center">
          <img src="rometrics-logo.png" class="logo">
          <h1 style="color:var(--primary)">Verify Email</h1>
          <p>A verification link has been sent to<br><b>${email}</b></p>
          <p style="font-size:0.85rem">You must verify before signing in.</p>
          <button class="btn btn-primary"
            onclick="window.location.href='signin.html'">
            Go to Sign In
          </button>
        </div>
      `;

    } catch (err) {
      console.error(err);
      msg(err.message || "Registration failed.");
    }
  };

});
</script>
</body>
</html>
