<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ROMetrics | Account Action</title>

<link rel="icon" type="image/png" sizes="192x192" href="favicon-192.png">
<link rel="apple-touch-icon" sizes="192x192" href="favicon-192.png">

<style>
:root {
  --bg:#0b1120;
  --card:#1e293b;
  --primary:#38bdf8;
  --text:#f8fafc;
  --muted:#94a3b8;
  --border:#334155;
  --error:#fb7185;
}

* { box-sizing:border-box; }
body {
  margin:0;
  min-height:100vh;
  font-family:system-ui,-apple-system,sans-serif;
  background:var(--bg);
  color:var(--text);
  display:flex;
  align-items:center;
  justify-content:center;
  padding:20px;
}

.card {
  width:100%;
  max-width:420px;
  background:var(--card);
  border:1px solid var(--border);
  border-top:4px solid var(--primary);
  border-radius:24px;
  padding:36px 30px;
  text-align:center;
}

.logo {
  height:42px;
  margin-bottom:14px;
}

h1 {
  margin:0 0 10px;
  font-size:1.4rem;
  font-weight:800;
}

p {
  font-size:.85rem;
  color:var(--muted);
}

button {
  width:100%;
  margin-top:16px;
  padding:14px;
  border-radius:12px;
  font-weight:700;
  border:none;
  background:var(--primary);
  color:#0b1120;
  cursor:pointer;
}

button.secondary {
  background:#0f172a;
  color:#fff;
  border:1px solid var(--border);
}
</style>
</head>

<body>

<div class="card">
  <a href="https://rometrics.app/">
    <img src="rometrics-logo.png" class="logo" alt="ROMetrics">
  </a>

  <div id="content"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyAxMFW5gguPiiaomPbuoMc7suxHmgPEhRg",
  authDomain: "rometricsapp-1444e.firebaseapp.com",
  projectId: "rometricsapp-1444e",
  appId: "1:1016564998048:web:1d4c7e4780de0323664ec5"
});

const auth = firebase.auth();
const qs = new URLSearchParams(window.location.search);
const mode = qs.get("mode");
const oobCode = qs.get("oobCode");
const isAndroid = qs.get("return") === "android";
const box = document.getElementById("content");

/* ===============================
   ANDROID HANDOFF (NEW)
   =============================== */
if (isAndroid) {
  auth.onAuthStateChanged(async (user) => {
    if (!user) {
      location.href = "signin.html?return=android";
      return;
    }

    const token = await user.getIdToken(true);

    box.innerHTML = `
      <h1>Signed In</h1>
      <p>You are signed in successfully.</p>

      <button onclick="location.href='rometrics://auth?token=${encodeURIComponent(token)}'">
        Return to App
      </button>

      <button class="secondary" onclick="location.href='https://rometrics.app/'">
        Stay on Web
      </button>
    `;
  });

  return;
}

/* ===============================
   INVALID / DIRECT ACCESS (WEB)
   =============================== */
if (!mode || !oobCode) {
  box.innerHTML = `
    <h1>Invalid Link</h1>
    <p>This link is invalid or has expired.</p>
    <button onclick="location.href='signin.html'">Go to Sign In</button>
  `;
}

/* ===============================
   EMAIL VERIFICATION
   =============================== */
else if (mode === "verifyEmail") {
  auth.applyActionCode(oobCode)
    .then(() => {
      box.innerHTML = `
        <h1>Email Verified</h1>
        <p>Your email has been successfully verified.</p>
        <button onclick="location.href='signin.html'">
          Continue to Sign In
        </button>
      `;
    })
    .catch(() => {
      box.innerHTML = `
        <h1>Verification Failed</h1>
        <p>This verification link is invalid or expired.</p>
        <button onclick="location.href='signin.html'">
          Go to Sign In
        </button>
      `;
    });
}

/* ===============================
   PASSWORD RESET
   =============================== */
else if (mode === "resetPassword") {
  box.innerHTML = `
    <h1>Reset Password</h1>
    <p>Enter a new password below.</p>

    <input id="newPass" type="password" placeholder="New password">
    <button id="resetBtn">Reset Password</button>

    <p id="resetMsg" class="msg"></p>
  `;

  document.getElementById("resetBtn").onclick = async () => {
    const pass = document.getElementById("newPass").value;
    const msg  = document.getElementById("resetMsg");

    if (pass.length < 6) {
      msg.textContent = "Password must be at least 6 characters.";
      msg.className = "msg error";
      return;
    }

    try {
      await auth.confirmPasswordReset(oobCode, pass);
      box.innerHTML = `
        <h1>Password Updated</h1>
        <p>Your password has been reset successfully.</p>
        <button onclick="location.href='signin.html'">
          Go to Sign In
        </button>
      `;
    } catch {
      msg.textContent = "This reset link is invalid or expired.";
      msg.className = "msg error";
    }
  };
}

/* ===============================
   OTHER MODES
   =============================== */
else {
  box.innerHTML = `
    <h1>Action Not Supported</h1>
    <p>This account action is not supported.</p>
    <button onclick="location.href='signin.html'">
      Go to Sign In
    </button>
  `;
}
</script>

</body>
</html>
