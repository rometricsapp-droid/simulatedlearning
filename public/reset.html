<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ROMetrics | Reset Password</title>

<link rel="icon" type="image/png" sizes="192x192" href="favicon-192.png">
<link rel="apple-touch-icon" sizes="192x192" href="favicon-192.png">

<style>
:root {
  --bg:#0b1120;
  --card:#1e293b;
  --primary:#38bdf8;
  --text:#f8fafc;
  --text-muted:#94a3b8;
  --border:#334155;
  --error:#fb7185;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{
  margin:0;min-height:100vh;
  font-family:system-ui,-apple-system,sans-serif;
  background:var(--bg);color:var(--text);
  display:flex;align-items:center;justify-content:center;padding:20px;
}
.auth-card{
  width:100%;max-width:420px;
  background:var(--card);
  border:1px solid var(--border);
  border-top:4px solid var(--primary);
  border-radius:24px;padding:36px 30px;
}
.logo-header{text-align:center;margin-bottom:20px}
.logo{height:42px;margin-bottom:12px}
h1{font-size:1.3rem;font-weight:800;margin:0 0 8px}
p{font-size:.85rem;color:var(--text-muted);margin:0 0 20px}
.console-msg{
  background:#0f172a;border:1px solid var(--border);
  border-radius:12px;padding:12px;font-size:12px;
  font-weight:600;text-align:center;margin-bottom:16px;display:none
}
.console-error{border-color:var(--error);color:var(--error)}
.console-info{border-color:var(--primary);color:var(--primary)}
.input-group{margin-bottom:14px}
.input-label{
  font-size:10px;font-weight:700;text-transform:uppercase;
  color:var(--primary);margin-bottom:6px;display:block
}
input{
  width:100%;background:#0f172a;border:1px solid var(--border);
  border-radius:12px;padding:12px 16px;color:#fff
}
.btn{
  width:100%;padding:14px;border-radius:12px;
  font-weight:700;cursor:pointer;border:none
}
.btn-primary{background:var(--primary);color:#0b1120}
</style>
</head>

<body>

<div class="auth-card">
  <div class="logo-header">
    <img src="rometrics-logo.png" class="logo" alt="ROMetrics">
    <h1>Reset Password</h1>
    <p>Enter a new password below.</p>
  </div>

  <div id="resetConsole" class="console-msg"></div>

  <div class="input-group">
    <span class="input-label">New Password</span>
    <input id="newPass" type="password">
  </div>

  <div class="input-group">
    <span class="input-label">Confirm Password</span>
    <input id="confirmPass" type="password">
  </div>

  <button class="btn btn-primary" id="doReset">
    Set New Password
  </button>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>

<script>
/* ===============================
   FIREBASE INIT
   =============================== */
firebase.initializeApp({
  apiKey: "AIzaSyAxMFW5gguPiiaomPbuoMc7suxHmgPEhRg",
  authDomain: "rometricsapp-1444e.firebaseapp.com",
  projectId: "rometricsapp-1444e",
  appId: "1:1016564998048:web:1d4c7e4780de0323664ec5"
});

const auth = firebase.auth();

/* ===============================
   TOKEN GUARD (CRITICAL)
   =============================== */
const params = new URLSearchParams(window.location.search);
const mode = params.get("mode");
const oobCode = params.get("oobCode");

if (mode !== "resetPassword" || !oobCode) {
  // Block random access
  window.location.replace("/signin.html");
}

/* ===============================
   UI HELPERS
   =============================== */
const msg = (text, type="error") => {
  const el = document.getElementById("resetConsole");
  el.textContent = text;
  el.className = `console-msg console-${type}`;
  el.style.display = "block";
};

/* ===============================
   RESET HANDLER
   =============================== */
document.getElementById("doReset").onclick = async () => {
  const pass = newPass.value;
  const confirm = confirmPass.value;

  if (!pass || pass.length < 6)
    return msg("Password must be at least 6 characters.");
  if (pass !== confirm)
    return msg("Passwords do not match.");

  try {
    await auth.confirmPasswordReset(oobCode, pass);
    msg("Password reset successful. Redirectingâ€¦", "info");

    setTimeout(() => {
      window.location.href = "/signin.html";
    }, 1500);

  } catch (err) {
    console.error(err);
    msg("Reset link is invalid or expired.");
  }
};
</script>
</body>
</html>
